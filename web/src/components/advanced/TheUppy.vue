<template>
  <!-- Uppy Dashboard 容器 -->
  <div id="uppy-dashboard" class="rounded-md overflow-hidden shadow-inner ring-inset ring-1 ring-gray-200">
  </div>
</template>

<script setup lang="ts">
import { ref, watch, onMounted, onBeforeUnmount } from 'vue'
import { getAuthToken } from '@/service/request/shared'
import { useUserStore } from '@/stores/user';
import { theToast } from '@/utils/toast';
import { storeToRefs } from 'pinia';
import { ImageSource } from '@/enums/enums';
/* --------------- 与Uppy相关 ---------------- */
import Uppy from '@uppy/core';
import Dashboard from '@uppy/dashboard';
import XHRUpload from '@uppy/xhr-upload';
import AwsS3, { type AwsBody } from '@uppy/aws-s3';
import '@uppy/core/css/style.min.css';
import '@uppy/dashboard/css/style.min.css';
import zh_CN from '@uppy/locales/lib/zh_CN'


let uppy: Uppy | null = null

const props = defineProps<{
  TheImageSource: string
}>()
const emit = defineEmits(["uppyUploaded"])

const files = ref<{ image_url: string; image_source: string }[]>([]);

const userStore = useUserStore();
const { isLogin } = storeToRefs(userStore);

// ✨ 监听粘贴事件
const handlePaste = (e: ClipboardEvent) => {
  if (!e.clipboardData) return

  for (const item of e.clipboardData.items) {
    if (item.type.startsWith("image/")) {
      const file = item.getAsFile()
      if (file) {
        uppy?.addFile({
          name: `pasted-${Date.now()}.png`,
          type: file.type,
          data: file,
          source: "PastedImage",
        })
        uppy?.upload()
      }
    }
  }
}

const initUppy = () => {
  console.log("TheImageSource", props.TheImageSource)

  uppy = new Uppy({
    restrictions: {
      maxNumberOfFiles: 6,
      allowedFileTypes: ['image/*'],
    },
    autoProceed: true,
  })

  uppy.use(Dashboard, {
    inline: true,
    target: '#uppy-dashboard',
    hideProgressDetails: false,
    hideUploadButton: false,
    hideCancelButton: false,
    hideRetryButton: false,
    hidePauseResumeButton: false,
    proudlyDisplayPoweredByUppy: false,
    height: 200,
    locale: zh_CN,
    note: '支持粘贴或选择图片上传哦！',
  })

  // 根据 props.TheImageSource 动态切换上传插件
  if (props.TheImageSource === ImageSource.LOCAL) {
    uppy.use(XHRUpload, {
      endpoint: 'http://localhost:6277/api/images/upload', // 本地上传接口
      fieldName: 'file',
      formData: true,
      headers: {
        "Authorization": `${getAuthToken()}`
      }
    });
  } else if (props.TheImageSource === ImageSource.S3) {
    uppy.use(AwsS3, {
      endpoint: 'http://localhost:6277/api/images/s3/get-presigned-url', // 获取预签名URL的接口

    });
  }

  document.addEventListener("paste", handlePaste)

  // uppy.on("file-added", file => {})
  uppy.on("upload", (uploadID, files) => {
    console.log("Upload started", uploadID, files)
    if (!isLogin.value) {
      theToast.error("请先登录再上传图片 😢")
      uppy?.cancelAll()
      return
    }
    theToast.info("正在上传图片，请稍等... ⏳")
  })
  uppy.on("upload-error", (file, error, response) => {
    type ResponseBody = {
      code: number;
      msg: string;
      data: any;
    };

    let errorMsg = "上传图片时发生错误 😢";

    const resp = response as any; // 忽略 TS 类型限制

    if (resp?.response) {
      let resObj: ResponseBody;

      if (typeof resp.response === "string") {
        resObj = JSON.parse(resp.response) as ResponseBody;
      } else {
        resObj = resp.response as ResponseBody;
      }

      if (resObj?.msg) {
        errorMsg = resObj.msg;
      }
    }

    theToast.error(errorMsg);
  });

  uppy.on("upload-success", (file, response) => {
    theToast.success(`好耶,上传成功！🎉`)
    const fileUrl = String(response.body?.data);
    const item = {
      image_url: fileUrl,
      image_source: props.TheImageSource === ImageSource.LOCAL ? ImageSource.LOCAL : ImageSource.S3
    }
    files.value.push(item);
  });
  uppy.on("complete", () => {
    emit("uppyUploaded", files.value); // 发射事件到父组件
  })
}

onMounted(() => {
  initUppy
})

// 监听 props.TheImageSource 变化
watch(
  () => props.TheImageSource,
  (newSource, oldSource) => {
    if (newSource !== oldSource) {
      // 销毁旧的 Uppy 实例
      uppy?.destroy()
      uppy = null
      files.value = [] // 清空已上传文件列表
      // 初始化新的 Uppy 实例
      initUppy();
    }
  }
);

onBeforeUnmount(() => {
  document.removeEventListener("paste", handlePaste)
  uppy?.destroy()
})
</script>

<style scoped>
:deep(.uppy-Root) {
  border: transparent;
}

:deep(.uppy-Dashboard-innerWrap) {
  background-color: #f4f1ec;
}

:deep(.uppy-Dashboard-AddFiles) {
  /* background-color: #fff; */
  /* 内阴影 */
  box-shadow: inset 0px 0px 2px rgba(80, 80, 80, 0.12), inset 0px 0px 2px rgba(80, 80, 80, 0.12);
}

:deep(.uppy-Dashboard-AddFiles-title) {
  color: #6f5427;
}

:deep(.uppy-Dashboard-browse) {
  color: #e5a437;
}

:deep(.uppy-DashboardContent-bar) {
  background-color: #fff;
}

:deep(.uppy-DashboardContent-back) {
  color: #cf8e12;
}

:deep(.uppy-DashboardContent-addMore) {
  color: #cf8e12;
}
</style>
