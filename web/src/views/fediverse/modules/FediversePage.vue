<template>
  <div class="max-w-sm px-3 pb-4 py-2 mt-4 sm:mt-6 mb-10 mx-auto flex justify-center items-center">
    <div class="w-full sm:max-w-lg">
      <h1 class="text-5xl text-center font-bold text-gray-200 mt-2 mb-4">Ech0 Fediverse</h1>

      <div class="flex items-center justify-between">
        <!-- 返回上一页 -->
        <BaseButton @click="goBack" class="w-10 h-10 text-gray-600 rounded-md" title="返回首页">
          <Arrow class="w-7 h-7 rotate-180 mx-auto" />
        </BaseButton>


        <!-- Actor搜索框 && NotificationBox -->
        <div class="flex items-center gap-1">
          <!-- Actor 搜索框 -->
          <BaseInput
            title="搜索"
            type="text"
            v-model="searchTerm"
            placeholder="搜索 Actor..."
            class="w-50 sm:w-55 h-10"
            @keyup.enter="$event.target.blur()"
            @blur="handleSearch"
          />
          <!-- NotificationBox -->
          <BaseButton
            class="h-full w-full text-gray-600 rounded-md flex items-center justify-center"
            title="消息通知"
            :icon="InBox"
            @click="theToast.info('消息通知功能开发中，敬请期待！')"
          />
        </div>
      </div>

      <!-- 在搜索时板块显示搜索结果 -->
      <div v-if="shouldShowResults" class="mt-6 space-y-4">
        <p v-if="searchLoading" class="text-sm text-gray-400">正在召唤联邦宇宙的朋友们…</p>
        <p v-else-if="searchError" class="text-sm text-red-400">{{ searchError }}</p>
        <TheActorCard
          v-else-if="searchResult"
          :actor="searchResult"
          :follow-loading="followLoading"
          :follow-success="followSuccess"
          @follow="handleFollow"
        />
        <p v-else class="text-sm text-gray-500">未找到相关 Actor，试试其他关键词吧。</p>
      </div>
      <!-- 未搜索时显示已关注的 Actor 的动态 -->
      <div
        v-else
        class="mt-6 rounded-lg border border-dashed border-gray-700/60 px-4 py-8 text-center text-gray-500"
      >
        功能开发中，敬请期待！
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted, ref, computed, watch } from 'vue'
import { theToast } from '@/utils/toast'

import { useRouter } from 'vue-router'
import BaseButton from '@/components/common/BaseButton.vue'
import BaseInput from '@/components/common/BaseInput.vue'
import Arrow from '@/components/icons/arrow.vue'
import InBox from '@/components/icons/inbox.vue'
import Search from '@/components/icons/search.vue'
import { fetchSearchFediverseActor, fetchFollowFediverseActor } from '@/service/api/fediverse'
import TheActorCard from '@/components/advanced/TheActorCard.vue'
import { useUserStore } from '@/stores/user'
import { storeToRefs } from 'pinia'

const router = useRouter()

const goBack = () => {
  if (window.history.length > 2) {
    window.history.back()
  } else {
    router.push({ name: 'home' }) // 没有历史记录则跳首页
  }
}

const userStore = useUserStore()
const { isLogin } = storeToRefs(userStore)

const searchTerm = ref('')
const hasSearched = ref(false)
const searchLoading = ref(false)
const searchError = ref('')
const searchResult = ref<App.Api.Fediverse.Actor | null>(null)
const followLoading = ref(false)
const followSuccess = ref(false)

const resetFollowState = () => {
  followLoading.value = false
  followSuccess.value = false
}

const shouldShowResults = computed(
  () => hasSearched.value || searchLoading.value || Boolean(searchError.value),
)

watch(
  () => searchTerm.value,
  (value) => {
    if (!value.trim()) {
      hasSearched.value = false
      searchLoading.value = false
      searchError.value = ''
      searchResult.value = null
      resetFollowState()
    }
    if (value.trim()) {
      followSuccess.value = false
    }
  },
)

const handleSearch = async (event?: KeyboardEvent | MouseEvent) => {
  if (!isLogin.value) {
    theToast.error('请先登录以使用联邦宇宙功能')
    return
  }

  if (event && 'target' in event) {
    const target = event.target as HTMLElement | null
    target?.blur()
  }

  const term = searchTerm.value.trim()
  if (!term) {
    hasSearched.value = false
    searchLoading.value = false
    searchError.value = ''
    searchResult.value = null
    resetFollowState()
    return
  }

  resetFollowState()
  hasSearched.value = true
  searchLoading.value = true
  searchError.value = ''
  searchResult.value = null

  try {
    const response = await fetchSearchFediverseActor(term)
    searchLoading.value = false

    if (response.code === 1 && response.data) {
      searchResult.value = response.data
    } else {
      searchResult.value = null
      searchError.value = response.msg || '未找到对应的 Actor'
    }
  } catch (error) {
    searchLoading.value = false
    searchResult.value = null
    searchError.value = error instanceof Error ? error.message : '搜索失败，请稍后再试'
  }
}

const handleFollow = async (actor: App.Api.Fediverse.Actor) => {
  if (followLoading.value) return

  if (!isLogin.value) {
    theToast.error('请先登录以使用联邦宇宙功能')
    return
  }

  const targetActor = typeof actor === 'object' ? (actor?.id as string | undefined) : undefined
  if (!targetActor) {
    theToast.error('未找到可用的 Actor 标识，无法发起关注')
    return
  }

  followLoading.value = true
  followSuccess.value = false

  try {
    const response = await fetchFollowFediverseActor({ targetActor })
    if (response.code === 1) {
      followSuccess.value = true
      theToast.success('关注请求已发送')
    } else {
      followSuccess.value = false
    }
  } catch (error) {
    followSuccess.value = false
    theToast.error(error instanceof Error ? error.message : '关注失败，请稍后再试')
  } finally {
    followLoading.value = false
  }
}

onMounted(() => {
  theToast.info('欢迎来到联邦宇宙！🎉', { duration: 3000 })
})
</script>
